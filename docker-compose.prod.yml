version: "3.8"
services:
  app:
    image: capstone_be:latest
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080
      # Provide your production connection string via env var or secret
      ConnectionStrings__DefaultConnection: ${CONNECTION_STRING}
    ports:
      - "8080:8080"
    volumes:
      # Persist ASP.NET Core DataProtection keys across restarts
      - dpkeys:/var/aspnet/DataProtection-Keys
    secrets:
      - aspnet_cert
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

secrets:
  aspnet_cert:
    file: ./secrets/aspnet_cert.pfx

volumes:
  dpkeys:
